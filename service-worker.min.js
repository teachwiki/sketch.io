/*sketchpad.pro © 2017 timescraper.com · All rights reserved.*//**
 * Integration config
 */

/*global window*/

var ICONFIG = {
    tmpVersion: 1570891429565,
    dataCacheName: "data-v3",
    cacheName: "teachwiki.github.io/sketch.io",
    domain: "teachwiki.github.io/sketch.io",
    shareTitle: "Invitation to Sketchpad.pro",
    shareText: "Join to real-time collaboration whiteboard",
    mailtoSubject: "Invitation to Sketchpad.pro",
    mailtoFooter: "\n\n--\nSketchpad.pro - Get Your Free Online Drawing Board\n",
    icons: {
        toolbar: {
            aipen: '<i class="fal fa-wand-magic"></i>',
            circ: '<i class="fal fa-circle" style="transform:scale(1.1,0.9);"></i>',
            circShift: '<i class="fal fa-circle"></i>',
            colorpicker: '<i class="fal fa-eye-dropper"></i>',
            cutout: '<i class="fal fa-cut"></i>',
            deleteSketch: '<i class="fal fa-trash-alt" aria-hidden="true"></i>',
            editors: '<i class="fal fa-key" aria-hidden="true"></i>',
            eraser: '<i class="fal fa-eraser"></i>',
            exportPng: '<i class="fal fa-file-image" aria-hidden="true"></i>',
            fullscreenOff: '<i class="fal fa-compress" aria-hidden="true"></i>',
            fullscreenOn: '<i class="fal fa-expand-arrows" aria-hidden="true"></i>',
            highlighter: '<i class="fal fa-paint-brush"></i>',
            image: '<i class="fal fa-image"></i>',
            layerDown: '<i class="fal fa-caret-down"></i>',
            layerUp: '<i class="fal fa-caret-up"></i>',
            line: '╱',
            lineShift: '&#9473;',
            load: '<i class="fal fa-folder-open"></i>',
            mandala: '<i class="fal fa-sun"></i>',
            moveViewport: '<i class="fal fa-hand-paper"></i>',
            pen: '<i class="fal fa-pencil"></i>',
            rainbow: '<i class="fal fa-cloud-rainbow"></i>',
            rect: '<i class="fal fa-rectangle-landscape"></i>',
            rectShift: '<i class="fal fa-square"></i>',
            redo: '<i class="fal fa-redo"></i>',
            resetSketch: '<i class="fal fa-trash" aria-hidden="true"></i>',
            rotateViewport: '<i class="fal fa-circle-notch"></i>',
            save: '<i class="fal fa-cloud-download" aria-hidden="true"></i>',
            share: '<i class="fal fa-share-alt" aria-hidden="true"></i>',
            smoothpen: '<i class="fal fa-pen-fancy"></i>',
            spectators: '<i class="fal fa-eye" aria-hidden="true"></i>',
            type: '<i class="fal fa-i-cursor"></i>',
            undo: '<i class="fal fa-undo"></i>',
            zoomCenter: '<i class="fal fa-home"></i>',
            zoomIn: '<i class="fal fa-search-plus"></i>',
            zoomOut: '<i class="fal fa-search-minus"></i>'
        },
        ui: {
            left: '<i class="fal fa-angle-left"></i>',
            right: '<i class="fal fa-angle-right"></i>',
            up: '<i class="fal fa-angle-up"></i>',
            down: '<i class="fal fa-angle-down"></i>',
            chatNewMessages: '<i class="fal fa-comment-alt" aria-hidden="true"></i>',
            chat: '<i class="fal fa-comment" aria-hidden="true"></i>',
            email: '<span class="fal fa-at" aria-hidden="true"></span>',
            close: '<i class="fal fa-times" aria-hidden="true"></i>'
            // link: '<i class="footInputIcon fal fa-link" aria-hidden="true"></i>'

        }
    },
    // defaultConfig: {
    //     tools: [
    //         "pen",
    //         "highlighter",
    //         "line",
    //         "rectangle",
    //         "circle",
    //         "type",
    //         "mandala",
    //         "rainbow",
    //         "image",
    //         "colorpicker",
    //         "undo-redo",
    //         "eraser",
    //         "move-viewport",
    //         "rotate-viewport",
    //         "zoom",
    //         "center"
    //     ],
    //     features: [
    //         "share",
    //         "upload",
    //         "reset",
    //         "layers-switcher",
    //         "chat",
    //         "webrtc",
    //         "download",
    //         // "export-image",
    //         "viewport-position",
    //         "connection-status",
    //         "exit"
    //     ]
    // },
    exitUrl: "sketchbook.html",
    avaliableTools: [],
    defaultTool: "smoothpen",

    postPdfUrl: "https://uploader.imagehost.pro:3443/upload",
    postImageUrl: "https://uploader.imagehost.pro:3443/upload",
    postWebshotUrl: "https://uploader.imagehost.pro:3443/webshot?site=",
    proxyImageUrl: "https://imagehost.pro/proxy.php",
    proxyExcludedDomain: "imagehost.pro",

    //please keep Appropriate Legal Notices
    watermarkTitle: "This is commercial version of sketchpad.pro.\nVisit http://developers.sketchpad.pro for open-source version.\nThis program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.",
    watermarkImageSrc: "data:image/svg+xml;utf8," + '<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg    xmlns:dc="http://purl.org/dc/elements/1.1/"    xmlns:cc="http://creativecommons.org/ns#"    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"    xmlns:svg="http://www.w3.org/2000/svg"    xmlns="http://www.w3.org/2000/svg"    xmlns:xlink="http://www.w3.org/1999/xlink"    xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"    xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"    width="128"    height="18"    viewBox="0 0 294.79549 53.369998"    id="svg2"    version="1.1"    inkscape:version="0.91 r13725"    sodipodi:docname="sketchpad-logo-clean.svg">   <sodipodi:namedview      pagecolor="#ffffff"      bordercolor="#666666"      borderopacity="1"      objecttolerance="10"      gridtolerance="10"      guidetolerance="10"      inkscape:pageopacity="0"      inkscape:pageshadow="2"      inkscape:window-width="1296"      inkscape:window-height="719"      id="namedview51"      showgrid="true"      inkscape:zoom="6.416994"      inkscape:cx="72.420486"      inkscape:cy="4.2725026"      inkscape:window-x="99"      inkscape:window-y="0"      inkscape:window-maximized="0"      inkscape:current-layer="layer1">     <inkscape:grid        type="xygrid"        id="grid3441" />   </sodipodi:namedview>   <defs      id="defs4">     <linearGradient        id="rainbow"        inkscape:collect="always">       <stop          offset="0"          style="stop-color:#ff0101;stop-opacity:1"          id="stop6" />       <stop          offset="0.04"          style="stop-color:#ff7901;stop-opacity:1"          id="stop8" />       <stop          offset="0.12"          style="stop-color:#fff001;stop-opacity:1"          id="stop10" />       <stop          offset="0.20"          style="stop-color:#96ff01;stop-opacity:1"          id="stop12" />       <stop          offset="0.27"          style="stop-color:#1fff01;stop-opacity:1"          id="stop14" />       <stop          offset="0.34"          style="stop-color:#01ff5b;stop-opacity:1"          id="stop16" />       <stop          offset="0.41"          style="stop-color:#01ffd2;stop-opacity:1"          id="stop18" />       <stop          offset="0.51"          style="stop-color:#01b4ff;stop-opacity:1"          id="stop20" />       <stop          offset="0.56"          style="stop-color:#013dff;stop-opacity:1"          id="stop22" />       <stop          offset="0.67"          style="stop-color:#3d01ff;stop-opacity:1"          id="stop24" />       <stop          offset="0.78"          style="stop-color:#b401ff;stop-opacity:1"          id="stop26" />       <stop          offset="0.87"          style="stop-color:#ff01d2;stop-opacity:1"          id="stop28" />       <stop          offset="0.95"          style="stop-color:#ff015b;stop-opacity:1"          id="stop30" />       <stop          offset="1"          style="stop-color:#ff0101;stop-opacity:1"          id="stop32" />     </linearGradient>     <linearGradient        xlink:href="#rainbow"        id="linearGradientRainbow"        gradientUnits="userSpaceOnUse"        x1="45"        y1="143"        x2="413"        y2="143"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3379"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3381"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3383"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3385"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3387"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3389"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3391"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3393"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3395"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3397"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3399"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3401"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />   </defs>   <metadata      id="metadata35">     <rdf:RDF>       <cc:Work          rdf:about="">         <dc:format>image/svg+xml</dc:format>         <dc:type            rdf:resource="http://purl.org/dc/dcmitype/StillImage" />         <dc:title></dc:title>         <dc:publisher>           <cc:Agent>             <dc:title></dc:title>           </cc:Agent>         </dc:publisher>         <dc:rights>           <cc:Agent>             <dc:title>AGPL</dc:title>           </cc:Agent>         </dc:rights>         <dc:creator>           <cc:Agent>             <dc:title>positivestuido.co</dc:title>           </cc:Agent>         </dc:creator>         <dc:date>2017</dc:date>         <dc:subject>           <rdf:Bag>             <rdf:li>sketch drawing board real-time canvas surface</rdf:li>           </rdf:Bag>         </dc:subject>       </cc:Work>     </rdf:RDF>   </metadata>   <g      inkscape:label="Layer 1"      inkscape:groupmode="layer"      id="layer1"      transform="translate(-359.92474,-9.2357351)">     <path        inkscape:connector-curvature="0"        id="path4215"        style="fill:url(#linearGradientRainbow);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 348.50715,25.511773 0,5.415323 -1.78128,0 0,-3.417866 -16.30852,0 0,7.412776 18.0898,0 0,11.407687 -24.70029,0 0,-5.415322 1.78127,0 0,3.417866 16.30852,0 0,-7.412776 -18.08979,0 0,-11.407688 24.70029,0 z" />     <path        inkscape:connector-curvature="0"        id="path4217"        style="fill:url(#linearGradient3401);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 380.66401,44.332237 0,1.997456 -9.65843,0 0,-1.997456 3.04795,0 -4.71047,-7.412776 -7.32301,0 0,7.412776 3.95839,0 0,1.997456 -14.48766,0 0,-1.997456 3.91879,0 0,-26.854671 -3.91879,0 0,-1.997453 10.52927,0 0,19.441893 7.28343,0 4.39379,-7.412776 -3.20628,0 0,-1.997457 9.65844,0 0,1.997457 -4.31462,0 -4.94798,8.344922 5.3834,8.478085 4.39378,0 z" />     <path        inkscape:connector-curvature="0"        id="path4219"        style="fill:url(#linearGradient3399);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 384.07627,25.511773 24.70027,0 0,11.407688 -18.08978,0 0,7.412776 16.30851,0 0,-3.417866 1.78127,0 0,5.415322 -24.70027,0 0,-20.81792 z m 6.61049,1.997457 0,7.412776 16.30851,0 0,-7.412776 -16.30851,0 z" />     <path        inkscape:connector-curvature="0"        id="path4221"        style="fill:url(#linearGradient3397);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 429.88582,44.332237 0,1.997456 -14.25015,0 0,-18.820463 -3.91879,0 0,-1.997457 3.91879,0 0,-10.03166 6.61049,0 0,10.03166 7.63966,0 0,1.997457 -7.63966,0 0,16.823007 7.63966,0 z" />     <path        inkscape:connector-curvature="0"        id="path4223"        style="fill:url(#linearGradient3395);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 456.01112,40.914371 1.78128,0 0,5.415322 -24.70029,0 0,-20.81792 24.70029,0 0,5.415323 -1.78128,0 0,-3.417866 -16.30851,0 0,16.823007 16.30851,0 0,-3.417866 z" />     <path        inkscape:connector-curvature="0"        id="path4225"        style="fill:url(#linearGradient3393);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 493.35532,44.332237 0,1.997456 -10.25221,0 0,-1.997456 4.23547,0 0,-16.823007 -16.3085,0 0,16.823007 3.91879,0 0,1.997456 -14.44809,0 0,-1.997456 3.91879,0 0,-26.854671 -3.91879,0 0,-1.997453 10.5293,0 0,10.03166 18.08978,0 0,18.820464 4.23546,0 z" />     <path        inkscape:connector-curvature="0"        id="path4227"        style="fill:url(#linearGradient3391);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 494.28615,54.3639 3.9188,0 0,-26.85467 -3.9188,0 0,-1.997457 29.17326,0 0,20.81792 -18.64395,0 0,8.034207 3.91879,0 0,1.997454 -14.4481,0 0,-1.997454 z m 27.39199,-26.85467 -16.86268,0 0,16.823007 16.86268,0 0,-16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4229"        style="fill:url(#linearGradient3389);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 552.68831,44.332237 3.91882,0 0,1.997456 -28.61909,0 0,-11.407687 18.08978,0 0,-7.412776 -16.30851,0 0,3.417866 -1.78127,0 0,-5.415323 24.70027,0 0,18.820464 z m -6.61049,0 0,-7.412776 -16.30851,0 0,7.412776 16.30851,0 z" />     <path        inkscape:connector-curvature="0"        id="path4231"        style="fill:url(#linearGradient3387);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 577.98669,25.511773 0,-8.034207 -3.91879,0 0,-1.997453 10.52928,0 0,28.852124 3.91879,0 0,1.997456 -29.17325,0 0,-20.81792 18.64397,0 z m -16.86269,18.820464 16.86269,0 0,-16.823007 -16.86269,0 0,16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4233"        style="fill:url(#linearGradient3385);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 599.21968,46.329693 -7.60009,0 0,-6.791347 7.60009,0 0,6.791347 z" />     <path        inkscape:connector-curvature="0"        id="path4235"        style="fill:url(#linearGradient3383);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 601.71129,54.3639 3.91879,0 0,-26.85467 -3.91879,0 0,-1.997457 29.17325,0 0,20.81792 -18.64396,0 0,8.034207 3.91878,0 0,1.997454 -14.44807,0 0,-1.997454 z m 27.39197,-26.85467 -16.86268,0 0,16.823007 16.86268,0 0,-16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4237"        style="fill:url(#linearGradient3381);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 659.83544,25.511773 0,5.370936 -1.78128,0 0,-3.373479 -12.86473,0 0,16.823007 3.91879,0 0,1.997456 -14.44807,0 0,-1.997456 3.91879,0 0,-16.823007 -3.91879,0 0,-1.997457 25.17529,0 z" />     <path        inkscape:connector-curvature="0"        id="path4239"        style="fill:url(#linearGradient3379);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 687.87312,46.329693 -24.70028,0 0,-20.81792 24.70028,0 0,20.81792 z m -1.78128,-18.820463 -16.3085,0 0,16.823007 16.3085,0 0,-16.823007 z" />   </g> </svg> '

};

// if (window) {
//     window.ICONFIG = ICONFIG;
// }


/*global self, caches, fetch, Notification, clients, ICONFIG*/

var dataCacheName = ICONFIG.dataCacheName;
var cacheName = ICONFIG.cacheName + "_" + ICONFIG.tmpVersion;

console.log("Service worker STARTED version:", dataCacheName, cacheName, ICONFIG);

var filesToCache = [

    // 'https://fonts.googleapis.com/css?family=Raleway', // <- do cache?

    'fontawesome5/js/packs/light.min.js',
    'fontawesome5/js/fontawesome.min.js',

    // 'fontawesome/fonts/fontawesome-webfont.woff2?v=4.7.0',

    // 'fontawesome/css/font-awesome.min.css',
    // 'fontawesome/fonts/fontawesome-webfont.eot',
    // 'fontawesome/fonts/fontawesome-webfont.svg',
    // 'fontawesome/fonts/fontawesome-webfont.ttf',
    // 'fontawesome/fonts/fontawesome-webfont.woff',
    // 'fontawesome/fonts/fontawesome-webfont.woff2',
    // 'fontawesome/fonts/FontAwesome.otf',

    'images/icons/bell-off-64x64.png',
    'images/icons/icon-128x128.png',
    'images/icons/icon-144x144.png',
    'images/icons/icon-152x152.png',
    'images/icons/icon-192x192.png',
    'images/icons/icon-256x256.png',
    'images/icons/icon-384x384.png',
    // 'images/icons/icon-256x256.gif',
    'images/icons/icon-512x512.png',

    //assets
    'images/index/embed.jpg',
    'images/index/free.jpg',
    'images/index/real-time.jpg',

    'images/slides/map.jpg',
    'images/slides/pdf.jpg',
    'images/slides/photo.jpg',


    'images/crosshair.png',
    'images/cursor.png',
    'images/null.png',
    'images/transparency.png',
    'images/transparency_default.png',
    'images/transparency_maps.png',
    'images/video.png',

    'css/advanced.css',
    'css/all.css',
    'css/contact.css',
    'css/help.css',
    'css/index.css',
    'css/sketchboard.css',
    'css/sketchbook.css',

    'js/advanced.js',
    'js/all.js',
    'js/contact.js',
    'js/help.js',
    'js/index.js',
    'js/sketchboard.js',
    'js/sketchbook.js',
    'js/sketchpad.js',

    'advanced.html',
    'contact.html',
    'help.html',
    'index.html',
    'sketchboard.html',
    'sketchbook.html',
    'sketchpad-logo-image.png',
    'favicon.ico'
];

function addChacheKillParam(urlString) {
    "use strict";
    // var url = new URL(urlString);
    // url.searchParams.append('cacheKill', cacheName);
    var delimiter = "?";
    if (urlString.indexOf("?") !== -1) {
        delimiter = "&";
    }
    return urlString + delimiter + cacheName;
    // return url.toString();
}


self.addEventListener("install", function (e) {
    "use strict";
    console.log("[ServiceWorker] Install");
    // e.waitUntil();
    e.waitUntil(Promise.all([
        self.skipWaiting(),
        caches.open(cacheName).then(function (cache) {
            var filesToCacheWithCacheKill = filesToCache.map(addChacheKillParam);
            console.log("[ServiceWorker] Caching app shell", filesToCacheWithCacheKill);
            // var result = false;
            // do not crash current event - try to cache new files in next loop
            setTimeout(function () {
                console.log("%cLIVE UPDATE STARTED", "color:blue");
                cache.addAll(filesToCacheWithCacheKill).then(function (res, err) {
                    console.log("%cLIVE UPDATE SUCCESS", "color:green");
                    console.log('cache.addAll(filesToCacheWithCacheKill) finished', res, err);
                    console.log('restarting in 3 sec.', res, err);
                    setTimeout(function () {
                        location.reload();
                    }, 3000);
                });
                
            }, 0);
            // return result;
        })
    ]));
});


self.addEventListener("activate", function (e) {
    "use strict";
    console.log("[ServiceWorker] Activate");
    e.waitUntil(Promise.all([
        self.clients.claim(),
        caches.keys().then(function (keyList) {
            return Promise.all(keyList.map(function (key) {
                if (key !== cacheName && key !== dataCacheName) {
                    console.log("[ServiceWorker] Removing old cache", key);
                    return caches.delete(key);
                }
            }));
        })
    ]));

    return self.clients.claim();
});

self.addEventListener("pushsubscriptionchange", function (event) {
    "use strict";
    console.log("Subscription expired");
    event.waitUntil(
        self.registration.pushManager.subscribe({
            userVisibleOnly: true
        })
            .then(function (subscription) {
                console.log('Subscribed after expiration', subscription.endpoint);
            })
    );
});

//internet first policy

self.addEventListener("fetch", function (e) {
    "use strict";
    if (e.request.method !== "GET") {
        return;
    }
    if (String(e.request.url).match(/^https?\:\/\/uploader\.imagehost\.pro(\:[0-9]+)?\//g)) {
        return;
    }
    if (String(e.request.url).match(/\/[A-F][0-9A-F]{10}[0-9]{2}[0-9A-F]{6}/g)) {
        e.respondWith(
            caches.match("sketchboard.html", {ignoreSearch: true, cacheName: cacheName}).then(function (responseCached) {
                if (responseCached) {
                    return responseCached;
                }
                return fetch(e.request);
            })
        );
    } else {
        e.respondWith(
            caches.match(e.request, {cacheName: cacheName, ignoreSearch: true}).then(function (response) {
                if (response) {
                    // console.log("[ServiceWorker] CACHED:", e.request.url);
                    return response;
                } else {
                    // console.warn("[ServiceWorker] DEFAULT FETCH:", e.request.url);
                    return fetch(e.request);
                }
            })
        );
    }
});


function showPushNotification(obj) {
    "use strict";
    var notificationTitle = "New notification",
        notificationConfig = {};
    // console.log("showPushNotification", obj.url, obj);
    switch (obj.cmd) {
    case "text-message":
        notificationTitle = obj.user_name + " says";
        notificationConfig = {
            // Whether you show data and how much you show depends on
            // content of the data itself.
            body: obj.message,
            icon: "images/icons/icon-128x128.png",
            tag: obj.url,//room_token
            actions: [
                {action: "open", title: "Open", icon: "images/icons/icon-128x128.png"}//,
                // {action: "bell-off", title: "Disable notifications", icon: "images/icons/bell-off-64x64.png"}
            ]

        };
        // console.log("Displaying notification", notificationTitle, notificationConfig);
        return self.registration.showNotification(notificationTitle, notificationConfig);
    case "user-hello":
        notificationTitle = obj.user.user_name + " is online";
        notificationConfig = {
            body: "Someone has connected to your room",
            icon: "images/icons/icon-128x128.png",
            tag: obj.url,//.room_token
            actions: [
                {action: "open", title: "Open", icon: "images/icons/icon-128x128.png"}//,
                //{action: "bell-off", title: "Disable notifications", icon: "images/icons/bell-off-64x64.png"}
            ]
        };
        // console.log("Displaying notification", notificationTitle, notificationConfig);
        return self.registration.showNotification(notificationTitle, notificationConfig);
    }
}
// musi byc w service workerze bo dziala on we wlasnym kontekscie bez apki
self.addEventListener("push", function (event) {
    "use strict";
    // console.log("ServiceWorker-PUSH-event3", event);
    var dataPromise;
    if (event && event.data) {
        dataPromise = Promise.resolve(event.data.json());
        // console.log("dataPromise", dataPromise);
    } else {
        console.log("No data in push message :(", event);
    }

    //  else {
    //toxdo, now ignore
    //     dataPromise = fetch('notification/end/point/data.json')
    //         .then(function (response) {
    //             return response.json();
    //         });
    // }

    event.waitUntil(
        clients.matchAll({
            type: "window"
        })
            .then(function (clientList) {
                dataPromise.then(function (data) {
                    data.control = 1;
                    // console.log("DATA FETCHED1", data);
                    // console.log("For url", data.url);
                    var i,
                        client,
                        tagedClient = false;
                    for (i = 0; i < clientList.length; i += 1) {
                        client = clientList[i];
                        if (String(client.url).indexOf(data.tag) !== -1) {
                            tagedClient = client;
                        }
                    }
                    if (!tagedClient) {
                        showPushNotification(data);
                        // dataPromise.then();
                    } else {
                        console.log(".service-worker.js", "ignore-push", "clientExists", clientList, clientList.length);
                    }
                });
            })
    );



    // event.waitUntil(

    // );

    // var data = {
    //     title: "Title"
    // };

    // var dataPromise;
    // if (event && event.data) {
    //     dataPromise = Promise.resolve(event.data.json());
    // } else {
    //     //fetch data from serve (data is not privided in event)
    //     dataPromise = fetch('notification/end/point/data.json')
    //         .then(function (response) {
    //             return response.json();
    //         });
    // }
    // // ws stay alive untlil done code promise
    // event.waitUntil(
    //     dataPromise.then(function (ignore) {
    //         // Now tell the user.
    //         return self.registration.showNotification(data.title, {
    //         // Whether you show data and how much you show depends on
    //         // content of the data itself.
    //             body: event.data.body,
    //             icon: 'images/icon.png',
    //             tag: "message_group",
    //             actions: [
    //                 {action: "my_action1", title: "Actoon1", icon: ""},
    //                 {action: "my_action2", title: "Actoon2", icon: ""}
    //             ]
    //         });
    //     })
    // );
});
self.addEventListener("notificationclick", function (event) {
    "use strict";
    console.log('On notification click: ', event);
    event.notification.close();
    switch (event.action) {
    case "bell-off":
        event.waitUntil(fetch('api/disable-notification-key='));
        break;
    default:
        //instant quit on click wierd ? auto-generated notification
        if (event.notification.tag === "user_visible_auto_notification") {
            return;
        }
        event.waitUntil(
            clients.matchAll({
                type: "window"
            })
                .then(function (clientList) {
                    var i, client;
                    for (i = 0; i < clientList.length; i += 1) {
                        // focused: true
                        // frameType: "top-level"
                        // id: "57eb0398-d808-4d69-a263-2fdc86ef3d61"
                        // url: "http://localhost/drawboard/sites/sketchpad.pro/public/F962ADE-20-21D9?password=4a4k4pas#p1491594957950.0303,0,0,r0,s1"
                        // visibilityState: "visible"
                        client = clientList[i];
                        console.log("client", client);
                        if (String(client.url).indexOf(event.notification.tag) !== -1) {
                            return client.focus();
                        }
                    }
                    if (clients.openWindow) {
                        return clients.openWindow("./" + event.notification.tag);//pass?-now is passed in tag, to-do?
                    }
                })
        );
        // clients.windowOpen(event.srcElement.location.origin);
    }
    // var messageId = event.notification.data;

    // event.notification.close();

    // if (event.action) {
    //     // Send the response directly to the server.
    // } else {
    //     // Open the app.
    // }
}, false);

self.addEventListener("notificationclose", function (event) {
    "use strict";
    var data = event.notification.data;
    console.log("Closed", event, data);
}, false);



console.log("[ServiceWorker]", "Notification.permission", Notification.permission);

// self.registration.showNotification("Service woerker", {
//     body: "Registered!",
//     icon: "data:image/gif;base64,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"
// });
